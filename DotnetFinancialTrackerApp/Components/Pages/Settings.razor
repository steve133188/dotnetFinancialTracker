@page "/settings"
@using DotnetFinancialTrackerApp.Models
@using DotnetFinancialTrackerApp.Services
@using DotnetFinancialTrackerApp.Components.Dialogs
@using DotnetFinancialTrackerApp.Components.Settings
@inject IUserService UserService
@inject IFamilyMemberService FamilyMemberService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<PageTitle>Settings</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="pa-4">
    <MudText Typo="Typo.h4" Class="mb-6" Style="font-weight: 700; color: #000;">Settings</MudText>

    <MudTabs Elevation="0" ApplyEffectsToContainer="true" Class="settings-tabs" PanelClass="pa-0 mt-4" @bind-ActivePanelIndex="_activeTabIndex">
        <MudTabPanel Text="Profile" Icon="@Icons.Material.Filled.Person">
            <ProfileTab CurrentUser="@_currentUser" OnUserUpdated="@HandleUserUpdated" />
        </MudTabPanel>

        <MudTabPanel Text="Security" Icon="@Icons.Material.Filled.Security">
            <SecurityTab CurrentUser="@_currentUser" OnPinUpdated="@HandlePinUpdated" />
        </MudTabPanel>

        <MudTabPanel Text="Family" Icon="@Icons.Material.Filled.Home">
            <FamilyTab FamilyMembers="@_familyMembers" OnFamilyUpdated="@HandleFamilyUpdated" />
        </MudTabPanel>

        <MudTabPanel Text="App" Icon="@Icons.Material.Filled.Settings">
            <AppTab />
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private UserProfile? _currentUser;
    private List<FamilyMember> _familyMembers = new();
    private int _activeTabIndex = 0;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            _isLoading = true;

            // Load current user (assuming user ID 1 for demo)
            _currentUser = await UserService.GetByIdAsync(1);

            // Load family members
            var defaultFamilyId = await FamilyMemberService.GetDefaultFamilyIdAsync();
            if (!string.IsNullOrEmpty(defaultFamilyId))
            {
                _familyMembers = await FamilyMemberService.GetAsync(defaultFamilyId);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleUserUpdated()
    {
        await LoadData();
        Snackbar.Add("Profile updated successfully", Severity.Success);
    }

    private async Task HandlePinUpdated()
    {
        await LoadData();
        Snackbar.Add("PIN updated successfully", Severity.Success);
    }

    private async Task HandleFamilyUpdated()
    {
        await LoadData();
        Snackbar.Add("Family settings updated successfully", Severity.Success);
    }
}

<style>
.settings-tabs .mud-tabs-toolbar {
    background: transparent;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.settings-tabs .mud-tab {
    color: #666;
    font-weight: 600;
    text-transform: none;
    min-width: auto;
    padding: 12px 16px;
}

.settings-tabs .mud-tab.mud-tab-active {
    color: #000;
    background: rgba(1, 255, 255, 0.1);
    border-radius: 8px 8px 0 0;
}

.settings-tabs .mud-tabs-panels {
    min-height: 500px;
}
</style>