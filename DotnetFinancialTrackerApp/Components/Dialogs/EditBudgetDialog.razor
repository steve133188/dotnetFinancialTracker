@using DotnetFinancialTrackerApp.Models

<MudDialog MaxWidth="MaxWidth.Small">
    <TitleContent>
        <MudText Typo="Typo.h6">@Title</MudText>
    </TitleContent>

    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_isValid" ValidationDelay="0">
            <MudStack Spacing="3">
                <MudAlert Severity="Severity.Info" Dense="true">
                    This budget will apply to all family spending for the selected month.
                </MudAlert>

                <MudTextField Label="Budget Name"
                              Variant="Variant.Outlined"
                              @bind-Value="_model.Name"
                              Placeholder="Family Budget" />

                <MudTextField Label="Description"
                              Variant="Variant.Outlined"
                              @bind-Value="_model.Description"
                              Lines="2"
                              Placeholder="Monthly spending limit for the entire family" />

                <MudNumericField T="decimal"
                                 Label="Budget Limit"
                                 Variant="Variant.Outlined"
                                 Immediate="true"
                                 Adornment="Adornment.Start"
                                 AdornmentText="$"
                                 @bind-Value="_model.Limit"
                                 Required="true"
                                 RequiredError="Budget limit is required"
                                 Validation="@ValidateLimit" />

                <MudDatePicker Label="Month"
                               Variant="Variant.Outlined"
                               @bind-Date="_budgetMonth"
                               Required="true"
                               RequiredError="Month is required"
                               DateFormat="MMMM yyyy"
                               AdornmentIcon="@Icons.Material.Outlined.CalendarMonth" />
            </MudStack>
        </MudForm>
    </DialogContent>

    <DialogActions>
        <MudSpacer />
        <MudButton Variant="Variant.Text" Color="Color.Secondary" Elevation="0" OnClick="@Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Default" Elevation="0" OnClick="@Ok" Style="background-color: black; color: white;">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Budget? Model { get; set; }

    private readonly Budget _model = new();
    private MudForm? _form;
    private bool _isValid;
    private DateTime? _budgetMonth;

    private string Title => _model.Id == 0 ? "Add Family Budget" : "Edit Family Budget";

    protected override Task OnInitializedAsync()
    {
        if (Model is not null)
        {
            _model.Id = Model.Id;
            _model.Name = Model.Name;
            _model.Description = Model.Description;
            _model.Limit = Model.Limit;
            _model.Month = Model.Month;
            _model.FamilyId = Model.FamilyId;
            _model.CreatedByMemberId = Model.CreatedByMemberId;
        }
        else
        {
            // Set defaults for new budget
            _model.Name = "Family Budget";
            _model.Description = "Monthly spending limit for the entire family";
        }

        _budgetMonth = _model.Month == default ? new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1) : _model.Month;

        return Task.CompletedTask;
    }

    private string? ValidateLimit(decimal? value)
    {
        if (value is null or <= 0)
        {
            return "Budget limit must be greater than zero";
        }

        return null;
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Ok()
    {
        if (_form is null)
        {
            return;
        }

        await _form.Validate();

        if (!_isValid || _budgetMonth is null)
        {
            return;
        }

        var month = _budgetMonth.Value;
        _model.Month = new DateTime(month.Year, month.Month, 1);

        // Ensure name is set
        if (string.IsNullOrWhiteSpace(_model.Name))
        {
            _model.Name = "Family Budget";
        }

        MudDialog.Close(DialogResult.Ok(_model));
    }
}
